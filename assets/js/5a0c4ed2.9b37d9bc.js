"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([[269957],{15680:(e,t,a)=>{a.d(t,{xA:()=>u,yg:()=>m});var o=a(296540);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,o)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function r(e,t){if(null==e)return{};var a,o,n=function(e,t){if(null==e)return{};var a,o,n={},i=Object.keys(e);for(o=0;o<i.length;o++)a=i[o],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)a=i[o],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=o.createContext({}),c=function(e){var t=o.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},u=function(e){var t=c(e.components);return o.createElement(l.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},g=o.forwardRef((function(e,t){var a=e.components,n=e.mdxType,i=e.originalType,l=e.parentName,u=r(e,["components","mdxType","originalType","parentName"]),p=c(a),g=n,m=p["".concat(l,".").concat(g)]||p[g]||d[g]||i;return a?o.createElement(m,s(s({ref:t},u),{},{components:a})):o.createElement(m,s({ref:t},u))}));function m(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=a.length,s=new Array(i);s[0]=g;var r={};for(var l in t)hasOwnProperty.call(t,l)&&(r[l]=t[l]);r.originalType=e,r[p]="string"==typeof e?e:n,s[1]=r;for(var c=2;c<i;c++)s[c]=a[c];return o.createElement.apply(null,s)}return o.createElement.apply(null,a)}g.displayName="MDXCreateElement"},243672:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>i,metadata:()=>r,toc:()=>c});var o=a(58168),n=(a(296540),a(15680));const i={title:"Config and install Compute Clusters",language:"en"},s=void 0,r={unversionedId:"install/cluster-deployment/k8s-deploy/compute-storage-decoupled/install-cluster/config-cc",id:"install/cluster-deployment/k8s-deploy/compute-storage-decoupled/install-cluster/config-cc",title:"Config and install Compute Clusters",description:"\x3c!--",source:"@site/docs/install/cluster-deployment/k8s-deploy/compute-storage-decoupled/install-cluster/config-cc.md",sourceDirName:"install/cluster-deployment/k8s-deploy/compute-storage-decoupled/install-cluster",slug:"/install/cluster-deployment/k8s-deploy/compute-storage-decoupled/install-cluster/config-cc",permalink:"/docs/dev/install/cluster-deployment/k8s-deploy/compute-storage-decoupled/install-cluster/config-cc",draft:!1,tags:[],version:"current",frontMatter:{title:"Config and install Compute Clusters",language:"en"},sidebar:"docs",previous:{title:"Config and install FE",permalink:"/docs/dev/install/cluster-deployment/k8s-deploy/compute-storage-decoupled/install-cluster/config-fe"},next:{title:"Deploying on AWS",permalink:"/docs/dev/install/cluster-deployment/doris-on-aws"}},l={},c=[{value:"Specify the name of the compute cluster",id:"specify-the-name-of-the-compute-cluster",level:2},{value:"Configuring multiple compute clusters",id:"configuring-multiple-compute-clusters",level:2},{value:"Configure resources",id:"configure-resources",level:2},{value:"Configure persistent storage",id:"configure-persistent-storage",level:2},{value:"Customize configuration files",id:"customize-configuration-files",level:2},{value:"Automatically add configuration",id:"automatically-add-configuration",level:3},{value:"Service storage configuration",id:"service-storage-configuration",level:3},{value:"Mount customized ConfigMap",id:"mount-customized-configmap",level:3}],u={toc:c},p="wrapper";function d(e){let{components:t,...a}=e;return(0,n.yg)(p,(0,o.A)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,n.yg)("p",null,"The Compute Cluster of Compute-storage decoupled cluster is responsible for data import and caching data in object storage. Compute clusters are isolated from each other."),(0,n.yg)("h2",{id:"specify-the-name-of-the-compute-cluster"},"Specify the name of the compute cluster"),(0,n.yg)("p",null,"The following configuration deploys a minimal compute cluster:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  computeClusters:\n  - name: cc1\n    image: {beImage}\n    replicas: 1\n")),(0,n.yg)("p",null,"The above configuration deploys a compute cluster named cc1. The deployment of the compute cluster depends on the deployment of the FE service. The Compute-storage decoupled cluster depends on the deployment of the metadata service. The variables in the above example are explained as follows:"),(0,n.yg)("p",null,(0,n.yg)("inlineCode",{parentName:"p"},"{beImage}")," is the image for deploying BE service."),(0,n.yg)("admonition",{title:"Tip",type:"tip"},(0,n.yg)("p",{parentName:"admonition"},"cc1 is the name of the compute cluster. During SQL execution, you can select the cluster you want to use by using the compute cluster name.")),(0,n.yg)("h2",{id:"configuring-multiple-compute-clusters"},"Configuring multiple compute clusters"),(0,n.yg)("p",null,"A ",(0,n.yg)("inlineCode",{parentName:"p"},"DorisDisaggregatedCluster")," resource can deploy multiple compute clusters, each of which is independent of each other and operates independently."),(0,n.yg)("p",null,"The simplest deployment of two compute clusters is as follows:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  computeClusters:\n  - name: cc1\n    image: {beImage}\n    replicas: 3\n  - name: cc2\n    image: {beImage}\n    replicas: 2\n")),(0,n.yg)("p",null,"The above is a simple configuration of two compute clusters, named cc1 and cc2. When using a Compute-storage decoupled cluster, you can select which compute cluster to use by the name of the compute cluster. In actual use, you can specify the cluster name according to the business category."),(0,n.yg)("p",null,"Modify the following configuration to the ",(0,n.yg)("inlineCode",{parentName:"p"},"DorisDisaggregatedCluster")," resource that needs to deploy Compute-storage decoupled cluster ","[quick_start]","(/docs/dev/install/cluster-deployment/k8s-deploy/compute-storage-decoupled/install-quickstart#Install DorisDisaggregatedCluster). You can deploy 2 compute clusters, one for 3 pods containing BE services, and one for 2 pods containing BE services. ",(0,n.yg)("inlineCode",{parentName:"p"},"{beImage}")," specifies the image of the BE service you want to use."),(0,n.yg)("admonition",{title:"Tip",type:"tip"},(0,n.yg)("p",{parentName:"admonition"},"The images used by multiple compute clusters should be kept consistent as much as possible.")),(0,n.yg)("h2",{id:"configure-resources"},"Configure resources"),(0,n.yg)("p",null,"Sets the CPU and Memory resource usage that can be used by the BE (Compute) container in each pod. Specify the CPU and Memory usage in ",(0,n.yg)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#requests-and-limits"},"resources.requests and resources.limits"),"."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  computeClusters:\n  - name: cc1\n    image: {beImage}\n    requests:\n      cpu: 4\n      memory: 8Gi\n    limits:\n      cpu: 4\n      memory: 8Gi\n")),(0,n.yg)("p",null,"The above configuration specifies the computing resources available for the compute cluster named cc1. You can fill in the information as needed and configure it in the ","[Deployment Compute-storage decoupled cluster]","(/docs/dev/install/cluster-deployment/k8s-deploy/compute-storage-decoupled/install-quickstart#Install DorisDisaggregatedCluster) ",(0,n.yg)("inlineCode",{parentName:"p"},"DorisDisaggregatedCluster")," resource. ",(0,n.yg)("inlineCode",{parentName:"p"},"{beImage}")," is the BE image you want to use."),(0,n.yg)("h2",{id:"configure-persistent-storage"},"Configure persistent storage"),(0,n.yg)("p",null,"By default, each BE service will use the EmptyDir storage mode to cache data. In real usage scenarios, you need to define the required storage size and the StorageClass you want to use based on actual needs."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-yaml"},'spec:\n  computeClusters:\n  - name: cc1\n    persistentVolume:\n      persistentVolumeClaimSpec:\n        #storageClassName\uff1a{storageClassName}\n        accessModes:\n        - ReadWriteOnce\n        resources:\n          requests:\n            storage: "200Gi"\n')),(0,n.yg)("p",null,"Configure 200Gi of persistent storage for the compute cluster named cc1, and use the default StorageClass in the K8s cluster to automatically create storage. If you need to specify a StorageClass, uncomment storageClassName to the name of the StorageClass you want to use."),(0,n.yg)("p",null,"The default Cache configuration of the BE service is ",(0,n.yg)("inlineCode",{parentName:"p"},'file_cache_path = [{"path":"/opt/apache-doris/be/storage","total_size":107374182400,"query_limit":107374182400}]')," The total available storage capacity is 100Gi, and the maximum available query capacity is 100Gi. In K8s deployment mode, Doris-Operator mounts customized persistent storage for each path. If you need to specify multiple paths to mount multiple disks as data cache, please refer to ","[Customized configuration file]","(/docs/dev/install/cluster-deployment/k8s-deploy/compute-storage-decoupled/install-cluster/config-cc#Customize configuration files)."),(0,n.yg)("admonition",{title:"Tip",type:"tip"},(0,n.yg)("p",{parentName:"admonition"},"The value of file_cache_path must be a JSON array.")),(0,n.yg)("h2",{id:"customize-configuration-files"},"Customize configuration files"),(0,n.yg)("p",null,"Under Compute-storage decoupled cluster, the BE service of each compute cluster is started by default using the configuration file in the image. In K8s deployment, the ConfigMap resource can be used to specify the BE startup configuration."),(0,n.yg)("h3",{id:"automatically-add-configuration"},"Automatically add configuration"),(0,n.yg)("p",null,"Under Compute-storage decoupled cluster, please refer to ",(0,n.yg)("a",{parentName:"p",href:"../../../../../compute-storage-decoupled/creating-cluster#beconf"},"Compute-storage decoupled Document")," for related configuration of BE service startup. In K8s deployment, ",(0,n.yg)("inlineCode",{parentName:"p"},"meta_service_endpoint"),", ",(0,n.yg)("inlineCode",{parentName:"p"},"cloud_unique_id"),", ",(0,n.yg)("inlineCode",{parentName:"p"},"meta_service_use_load_balancer"),", ",(0,n.yg)("inlineCode",{parentName:"p"},"enable_file_cache")," do not need to be filled in."),(0,n.yg)("p",null,(0,n.yg)("inlineCode",{parentName:"p"},"meta_service_endpoint")," Related services in K8s deployment will automatically generate real address information based on the ",(0,n.yg)("inlineCode",{parentName:"p"},"DorisDisaggregatedMetaService")," information configured in ",(0,n.yg)("inlineCode",{parentName:"p"},"DorisDisaggregatedCluster")," and automatically add it."),(0,n.yg)("p",null,(0,n.yg)("inlineCode",{parentName:"p"},"cloud_unique_id")," is automatically added to the relevant services in K8s deployment, no need to specify."),(0,n.yg)("p",null,(0,n.yg)("inlineCode",{parentName:"p"},"meta_service_use_load_balancer")," is automatically added to the relevant services in K8s deployment with a default value of false."),(0,n.yg)("p",null,(0,n.yg)("inlineCode",{parentName:"p"},"enable_file_cache")," is automatically set to the default value of true for the relevant services in K8s deployment."),(0,n.yg)("h3",{id:"service-storage-configuration"},"Service storage configuration"),(0,n.yg)("p",null,"The BE service customizes the startup configuration in Compute-storage decoupled mode, and must specify ",(0,n.yg)("inlineCode",{parentName:"p"},"file_cache_path")," according to the ",(0,n.yg)("a",{parentName:"p",href:"../../../../../compute-storage-decoupled/creating-cluster#beconf"},"Compute-storage decoupled document"),". In K8s deployment, the relevant services will automatically mount persistent storage according to the ","[persistence related configuration]","(/docs/dev/install/cluster-deployment/k8s-deploy/compute-storage-decoupled/install-cluster/config-cc#Configure persistent storage)."),(0,n.yg)("p",null,"For example: ",(0,n.yg)("inlineCode",{parentName:"p"},"file_cache_path")," is configured as ",(0,n.yg)("inlineCode",{parentName:"p"},'file_cache_path = [{"path":"/opt/apache-doris/be/storage","total_size":107374182400,"query_limit":107374182400}]'),", Doris-Operator related services automatically add storage configuration information for the computing service, which can apply for a disk with a mount point of ",(0,n.yg)("inlineCode",{parentName:"p"},"/opt/apache-doris/be/storage")," and a capacity of 100Gi."),(0,n.yg)("p",null,"When total_size in file_cache_path is greater than the storage capacity of ","[persistent configuration]","(/docs/dev/install/cluster-deployment/k8s-deploy/compute-storage-decoupled/install-cluster/config-cc#Configure persistent storage), Doris-Operator will change the persistent configuration to the size of total_size to prevent unexpected service failures."),(0,n.yg)("h3",{id:"mount-customized-configmap"},"Mount customized ConfigMap"),(0,n.yg)("p",null,"After the configuration file is prepared according to the above rules, deploy it to the namespace of the ",(0,n.yg)("inlineCode",{parentName:"p"},"DorisDisaggregatedCluster")," deployment, and modify the ",(0,n.yg)("inlineCode",{parentName:"p"},"DorisDisaggregatedCluster")," resource to be deployed to specify which compute cluster to start with the customized configuration."),(0,n.yg)("p",null,"For example, the startup configuration is as follows:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: be-configmap\n  labels:\n    app.kubernetes.io/component: be\ndata:\n  be.conf: |\n    # For jdk 17, this JAVA_OPTS will be used as default JVM options\n    JAVA_OPTS_FOR_JDK_17="-Xmx1024m -DlogPath=$LOG_DIR/jni.log -Xlog:gc*:$LOG_DIR/be.gc.log.$CUR_DATE:time,uptime:filecount=10,filesize=50M -Djavax.security.auth.useSubjectCredsOnly=false -Dsun.security.krb5.debug=true -Dsun.java.command=DorisBE -XX:-CriticalJNINatives -XX:+IgnoreUnrecognizedVMOptions --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.lang.invoke=ALL-UNNAMED --add-opens=java.base/java.lang.reflect=ALL-UNNAMED --add-opens=java.base/java.io=ALL-UNNAMED --add-opens=java.base/java.net=ALL-UNNAMED --add-opens=java.base/java.nio=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.util.concurrent=ALL-UNNAMED --add-opens=java.base/java.util.concurrent.atomic=ALL-UNNAMED --add-opens=java.base/sun.nio.ch=ALL-UNNAMED --add-opens=java.base/sun.nio.cs=ALL-UNNAMED --add-opens=java.base/sun.security.action=ALL-UNNAMED --add-opens=java.base/sun.util.calendar=ALL-UNNAMED --add-opens=java.security.jgss/sun.security.krb5=ALL-UNNAMED --add-opens=java.management/sun.management=ALL-UNNAMED"\n    file_cache_path = [{"path":"/mnt/disk1/doris_cloud/file_cache","total_size":104857600000,"query_limit":10485760000}, {"path":"/mnt/disk2/doris_cloud/file_cache","total_size":104857600000,"query_limit":10485760000}]\n')),(0,n.yg)("p",null,"The configuration that specifies the compute cluster to use the above ConfigMap is as follows:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-yaml"},'spec:\n  computeClusters:\n  - name: cc1\n    image: {beImage}\n    configMaps:\n    - name: be-configmap\n      mountPath: "/etc/doris"\n')),(0,n.yg)("p",null,"After modifying the configuration, update the configuration information to the deployed ","[DorisDisaggregatedCluster]","(/docs/dev/install/cluster-deployment/k8s-deploy/compute-storage-decoupled/install-quickstart#Install DorisDisaggregatedCluster) resource."),(0,n.yg)("admonition",{title:"Tip",type:"tip"},(0,n.yg)("p",{parentName:"admonition"},"All startup configurations must be mounted in the /etc/doris directory.")))}d.isMDXComponent=!0}}]);